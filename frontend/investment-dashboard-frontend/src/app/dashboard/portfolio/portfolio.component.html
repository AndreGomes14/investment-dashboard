<div class="loading-container" *ngIf="!(summaryData$ | async)">
  <mat-spinner diameter="50"></mat-spinner>
  <p>Loading Portfolio Data...</p>
</div>

<ng-container *ngIf="summaryData$ | async as summaryData">

  <div *ngIf="!summaryData" class="no-data-container">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Error Loading Portfolio</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p>Could not load portfolio data at this time. Please try again later.</p>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="portfolio-container" *ngIf="summaryData">
    <div class="page-header">
      <h1>Portfolio Overview</h1>
      <p class="subtitle">{{ summaryData.summary.portfolioName }}</p>
    </div>

    <div style="margin-bottom: 20px; margin-top: 10px; display: flex; justify-content: flex-start;">
      <button mat-raised-button color="primary" 
              (click)="refreshPortfolioValues()" 
              [disabled]="isRefreshingValues || isLoadingSummary"
              [attr.aria-label]="portfolioId ? 'Refresh values for this portfolio' : 'Refresh values for all my investments'">
        <mat-icon *ngIf="!isRefreshingValues">refresh</mat-icon>
        <mat-progress-spinner *ngIf="isRefreshingValues" mode="indeterminate" diameter="20" style="display: inline-block; margin-right: 8px;"></mat-progress-spinner>
        {{ isRefreshingValues ? 'Refreshing...' : (portfolioId ? 'Refresh Portfolio Values' : 'Refresh All My Investments') }}
      </button>
    </div>

    <div class="metrics-row">
      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="metric-icon">payments</mat-icon>
          <mat-card-title>Total Invested</mat-card-title>
          <mat-card-subtitle>Cost Basis</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <h2 class="metric-value">{{ summaryData.summary.totalCostBasis | currency:preferredCurrency:'symbol':'1.2-2' }}</h2>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="metric-icon">account_balance_wallet</mat-icon>
          <mat-card-title>Total Value</mat-card-title>
          <mat-card-subtitle>Active Holdings</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <h2 class="metric-value">{{ displayTotalValue | currency:preferredCurrency:'symbol':'1.2-2' }}</h2>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="metric-icon">trending_up</mat-icon>
          <mat-card-title>Unrealized Gain/Loss</mat-card-title>
          <mat-card-subtitle>Return on Active Holdings</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <h2 class="metric-value" [ngClass]="displayUnrealizedPnlAbsolute >= 0 ? 'positive' : 'negative'">
            {{ displayUnrealizedPnlAbsolute | currency:preferredCurrency:'symbol':'1.2-2' }}
          </h2>
          <div class="metric-change" [ngClass]="summaryData.summary.unrealizedPnlPercentage >= 0 ? 'positive' : 'negative'">
            <mat-icon>{{ summaryData.summary.unrealizedPnlPercentage >= 0 ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
            <span>{{ summaryData.summary.unrealizedPnlPercentage | number:'1.1-2' }}% unrealized</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="metric-icon">paid</mat-icon>
          <mat-card-title>Realized Gain/Loss</mat-card-title>
          <mat-card-subtitle>From Sold Holdings</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <h2 class="metric-value" [ngClass]="summaryData.summary.realizedPnlAbsolute >= 0 ? 'positive' : 'negative'">
            {{ summaryData.summary.realizedPnlAbsolute | currency:preferredCurrency:'symbol':'1.2-2' }}
          </h2>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="metrics-row">
      <!-- Asset Allocation Card -->
      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="metric-icon">pie_chart</mat-icon>
          <mat-card-title>Asset Allocation</mat-card-title>
          <mat-card-subtitle>By Current Value</mat-card-subtitle>
          <button mat-icon-button class="details-button" (click)="openAllocationDetails()">
            <mat-icon>info</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="allocationChartData$ | async as chartData; else noChartData" style="height: 200px;">
            <ngx-charts-pie-chart
              *ngIf="chartData.length > 0"
              [results]="chartData"
              [legend]="false"
              [labels]="true"
              [doughnut]="true"
              [arcWidth]="0.25"
              [scheme]="allocationColorScheme" >
            </ngx-charts-pie-chart>
            <div *ngIf="chartData.length === 0" class="allocation-chart-placeholder">
              No allocation data available (value might be zero).
            </div>
          </div>
          <ng-template #noChartData>
            <div class="allocation-chart-placeholder">Loading chart...</div>
          </ng-template>
        </mat-card-content>
      </mat-card>

      <!-- Currency Allocation Card -->
      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="metric-icon">public</mat-icon>
          <mat-card-title>Currency Allocation</mat-card-title>
          <mat-card-subtitle>By Current Value</mat-card-subtitle>
          <button mat-icon-button class="details-button" (click)="openCurrencyAllocationDetails()">
            <mat-icon>info</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="currencyAllocationChartData$ | async as curData; else noCurrencyData" style="height: 200px;">
            <ngx-charts-pie-chart
              *ngIf="curData.length > 0"
              [results]="curData"
              [legend]="false"
              [labels]="true"
              [doughnut]="true"
              [arcWidth]="0.25"
              [scheme]="currencyColorScheme">
            </ngx-charts-pie-chart>
            <div *ngIf="curData.length === 0" class="allocation-chart-placeholder">
              No currency allocation data (value might be zero).
            </div>
          </div>
          <ng-template #noCurrencyData>
            <div class="allocation-chart-placeholder">Loading chart...</div>
          </ng-template>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Historical Value Chart Section -->
    <div class="chart-section" *ngIf="!portfolioId">
      <h2 class="section-title">Overall Portfolio Value History</h2>
      <mat-card class="historical-chart-card" [class.fullscreen-chart-card]="isHistoryChartFullscreen">
        <button mat-icon-button (click)="toggleHistoryChartFullscreen()" class="fullscreen-button" aria-label="Toggle fullscreen for history chart">
          <mat-icon>{{ isHistoryChartFullscreen ? 'fullscreen_exit' : 'fullscreen' }}</mat-icon>
        </button>
      <mat-card-content [class.fullscreen-chart-content]="isHistoryChartFullscreen">
        <div class="time-range-selector" style="margin-bottom: 16px;" *ngIf="!isHistoryChartFullscreen">
          <mat-button-toggle-group #group="matButtonToggleGroup" (valueChange)="setTimeRange($event)" [value]="selectedTimeRange$ | async">
            <mat-button-toggle value="7d">7D</mat-button-toggle>
            <mat-button-toggle value="1m">1M</mat-button-toggle>
            <mat-button-toggle value="3m">3M</mat-button-toggle>
            <mat-button-toggle value="6m">6M</mat-button-toggle>
            <mat-button-toggle value="1y">1Y</mat-button-toggle>
            <mat-button-toggle value="all">All</mat-button-toggle>
          </mat-button-toggle-group>
        </div>

        <ng-container *ngIf="historicalData$ | async as historyData">
          <div *ngIf="isLoadingHistory" class="chart-loading-spinner">
            <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
            <p>Loading history...</p>
          </div>

          <div *ngIf="!isLoadingHistory">
            <div *ngIf="historyData && historyData.length > 0 && historyData[0].series.length > 0; else noHistoryData" 
                 [style.height.px]="isHistoryChartFullscreen ? (0.8 * windowHeight) : 300"
                 class="chart-container">
              <ngx-charts-line-chart
                [results]="historyData"
                [scheme]="historyChartColorScheme"
                [legend]="false"
                [xAxis]="true"
                [yAxis]="true"
                [showXAxisLabel]="true"
                [showYAxisLabel]="true"
                [xAxisLabel]="'Date'"
                [yAxisLabel]="'Total Value'"
                [autoScale]="true"
                [timeline]="false"
                [xAxisTickFormatting]="formatXAxisTick"
                [roundDomains]="true">
              </ngx-charts-line-chart>
            </div>
            <ng-template #noHistoryData>
              <p style="text-align: center; padding: 20px;">No historical data available for the selected range.</p>
            </ng-template>
          </div>
        </ng-container>
      </mat-card-content>
    </mat-card>
    </div>

    <div class="holdings-section" *ngIf="summaryData.activeInvestments && summaryData.activeInvestments.length > 0">
      <div class="section-header">
        <h2>Active Holdings ({{ summaryData.summary.activeInvestmentsCount }})</h2>
        <span class="spacer"></span>
        <button mat-raised-button color="primary" routerLink="../investments">
          <mat-icon>settings</mat-icon> Manage Investments
        </button>
      </div>
      <mat-card>
        <div class="table-responsive">
          <table class="holdings-table">
            <thead>
            <tr>
              <th class="asset-header">
                <span class="sortable" (click)="sortBy('asset')">
                  Asset (Ticker)
                  <mat-icon *ngIf="sortColumn==='asset'">
                    {{ sortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </mat-icon>
                </span>
                <button mat-icon-button color="primary" (click)="toggleAssetSearch(); $event.stopPropagation();" aria-label="Filter assets">
                  <mat-icon>{{ showAssetSearch ? 'close' : 'search' }}</mat-icon>
                </button>
                <input *ngIf="showAssetSearch" type="text" [(ngModel)]="assetFilter" placeholder="Search..." class="asset-search-inline" (click)="$event.stopPropagation()" />
              </th>
              <th (click)="sortBy('type')" class="sortable">Type
                <mat-icon *ngIf="sortColumn==='type'">
                  {{ sortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="sortBy('units')" class="sortable">Units
                <mat-icon *ngIf="sortColumn==='units'">
                  {{ sortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="sortBy('purchasePrice')" class="sortable">Purchase Price
                <mat-icon *ngIf="sortColumn==='purchasePrice'">
                  {{ sortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="sortBy('totalCost')" class="sortable">Total Cost
                <mat-icon *ngIf="sortColumn==='totalCost'">
                  {{ sortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="sortBy('currentPrice')" class="sortable">Current Price
                <mat-icon *ngIf="sortColumn==='currentPrice'">
                  {{ sortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="sortBy('value')" class="sortable">Total Value
                <mat-icon *ngIf="sortColumn==='value'">
                  {{ sortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="sortBy('profit')" class="sortable">Profit/Loss
                <mat-icon *ngIf="sortColumn==='profit'">
                  {{ sortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="sortBy('percentProfit')" class="sortable">Profit %
                <mat-icon *ngIf="sortColumn==='percentProfit'">
                  {{ sortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
            </tr>
            </thead>
            <tbody *ngIf="getSortedActiveInvestments(summaryData.activeInvestments) as holdings">
            <tr *ngIf="holdings.length === 0">
              <td colspan="9" style="text-align:center; padding:16px;">No investments match your search.</td>
            </tr>
            <tr *ngFor="let investment of holdings">
              <td>
                <ng-container *ngIf="investment.type === 'Other'">
                  {{ investment.customName || 'Unnamed Custom Asset' }} (Other)
                </ng-container>
                <ng-container *ngIf="investment.type !== 'Other'">
                  {{ investment.ticker }}
                </ng-container>
              </td>
              <td>{{ investment.type }}</td>
              <td>{{ investment.amount | number:'1.0-4' }}</td>
              <td>{{ investment.purchasePrice | currency:investment.currency:'symbol':'1.2-2' }}</td>
              <td>{{ investment.totalCost | currency:investment.currency:'symbol':'1.2-2' }}</td>
              <td>{{ (investment.currentValue ?? 0) | currency:investment.currency:'symbol':'1.2-2' }}</td>
              <td>{{ ((investment.currentValue ?? 0) * investment.amount) | currency:investment.currency:'symbol':'1.2-2' }}</td>
              <td>
                <span class="profit-value"
                      *ngIf="investment.profitOrLoss !== undefined && investment.profitOrLoss !== null"
                      [class.positive]="investment.profitOrLoss >= 0"
                      [class.negative]="investment.profitOrLoss < 0">
                  {{ investment.profitOrLoss | currency:investment.currency:'symbol':'1.2-2' }}
                </span>
                <span class="unavailable" *ngIf="investment.profitOrLoss === undefined || investment.profitOrLoss === null">N/A</span>
              </td>
              <td>
                   <span class="profit-value"
                         *ngIf="investment.percentProfit !== null"
                         [class.positive]="(investment.percentProfit ?? 0) > 0"
                         [class.negative]="(investment.percentProfit ?? 0) < 0">
                      {{ investment.percentProfit | percent:'1.2-2' }}
                   </span>
                <span class="unavailable" *ngIf="investment.percentProfit === null">N/A</span>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </mat-card>
    </div>

    <div class="holdings-section" *ngIf="summaryData.soldInvestments && summaryData.soldInvestments.length > 0">
      <div class="section-header">
        <h2>Sold Holdings History</h2>
      </div>
      <mat-card>
        <div class="table-responsive">
          <table class="holdings-table">
            <thead>
            <tr>
              <th class="asset-header">
                <span class="sortable" (click)="soldSortBy('asset')">
                  Asset (Ticker)
                  <mat-icon *ngIf="soldSortColumn==='asset'">
                    {{ soldSortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </mat-icon>
                </span>
                <button mat-icon-button color="primary" (click)="toggleSoldAssetSearch(); $event.stopPropagation();" aria-label="Filter assets">
                  <mat-icon>{{ showSoldAssetSearch ? 'close' : 'search' }}</mat-icon>
                </button>
                <input *ngIf="showSoldAssetSearch" type="text" [(ngModel)]="soldAssetFilter" placeholder="Search..." class="asset-search-inline" (click)="$event.stopPropagation()" />
              </th>
              <th (click)="soldSortBy('type')" class="sortable">Type
                <mat-icon *ngIf="soldSortColumn==='type'">
                  {{ soldSortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="soldSortBy('units')" class="sortable">Units
                <mat-icon *ngIf="soldSortColumn==='units'">
                  {{ soldSortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="soldSortBy('purchasePrice')" class="sortable">Purchase Price
                <mat-icon *ngIf="soldSortColumn==='purchasePrice'">
                  {{ soldSortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="soldSortBy('sellPrice')" class="sortable">Sell Price
                <mat-icon *ngIf="soldSortColumn==='sellPrice'">
                  {{ soldSortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="soldSortBy('dateSold')" class="sortable">Date Sold
                <mat-icon *ngIf="soldSortColumn==='dateSold'">
                  {{ soldSortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="soldSortBy('realizedPnl')" class="sortable">Realized PnL
                <mat-icon *ngIf="soldSortColumn==='realizedPnl'">
                  {{ soldSortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
              <th (click)="soldSortBy('percentProfit')" class="sortable">Profit %
                <mat-icon *ngIf="soldSortColumn==='percentProfit'">
                  {{ soldSortDirection==='asc' ? 'arrow_upward' : 'arrow_downward' }}
                </mat-icon>
              </th>
            </tr>
            </thead>
            <tbody *ngIf="getSortedSoldInvestments(summaryData.soldInvestments) as soldHoldings">
            <tr *ngIf="soldHoldings.length === 0">
              <td colspan="8" style="text-align:center; padding:16px;">No sold investments match your search.</td>
            </tr>
            <tr *ngFor="let investment of soldHoldings">
              <td>
                <ng-container *ngIf="investment.type === 'Other'">
                  {{ investment.customName || 'Unnamed Custom Asset' }} (Other)
                </ng-container>
                <ng-container *ngIf="investment.type !== 'Other'">
                  {{ investment.ticker }}
                </ng-container>
              </td>
              <td>{{ investment.type }}</td>
              <td>{{ investment.amount | number:'1.0-4' }}</td>
              <td>{{ investment.purchasePrice | currency:investment.currency:'symbol':'1.2-2' }}</td>
              <td>{{ (investment.sellPrice ?? 0) | currency:investment.currency:'symbol':'1.2-2' }}</td>
              <td>{{ investment.lastUpdateDate | date:'shortDate' }}</td>
              <td>
                   <span class="profit-value"
                         *ngIf="investment.sellPrice !== null && investment.purchasePrice !== null"
                         [class.positive]="((investment.sellPrice || 0) - (investment.purchasePrice || 0)) > 0"
                         [class.negative]="((investment.sellPrice || 0) - (investment.purchasePrice || 0)) < 0">
                       {{ ((investment.sellPrice || 0) - (investment.purchasePrice || 0)) * (investment.amount || 0) | currency:investment.currency:'symbol':'1.2-2' }}
                   </span>
                <span class="unavailable" *ngIf="investment.sellPrice === null || investment.purchasePrice === null">N/A</span>
              </td>
              <td>
                   <span class="profit-value"
                         *ngIf="investment.sellPrice !== null && investment.purchasePrice !== null && investment.purchasePrice !== 0"
                         [class.positive]="((investment.sellPrice || 0) - (investment.purchasePrice || 0)) > 0"
                         [class.negative]="((investment.sellPrice || 0) - (investment.purchasePrice || 0)) < 0">
                        {{ (((investment.sellPrice || 0) - (investment.purchasePrice || 0)) / (investment.purchasePrice || 1)) | percent:'1.2-2' }}
                   </span>
                <span class="unavailable" *ngIf="investment.sellPrice === null || investment.purchasePrice === null || investment.purchasePrice === 0">N/A</span>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </mat-card>
    </div>

  </div>

</ng-container>

<div class="loading-container" *ngIf="!(summaryData$ | async)">
  <mat-spinner diameter="50"></mat-spinner>
  <p>Loading Portfolio Data...</p>
</div>

<ng-container *ngIf="summaryData$ | async as summaryData">

  <div *ngIf="!summaryData" class="no-data-container">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Error Loading Portfolio</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p>Could not load portfolio data at this time. Please try again later.</p>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="portfolio-container" *ngIf="summaryData">
    <div class="page-header">
      <h1>Portfolio Overview</h1>
      <p class="subtitle">{{ summaryData.summary.portfolioName }}</p>
    </div>

    <div class="metrics-row">
      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="metric-icon">account_balance_wallet</mat-icon>
          <mat-card-title>Total Value</mat-card-title>
          <mat-card-subtitle>Active Holdings</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <h2 class="metric-value">{{ summaryData.summary.totalValue | currency:'USD':'symbol':'1.2-2' }}</h2>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="metric-icon">trending_up</mat-icon>
          <mat-card-title>Unrealized Gain/Loss</mat-card-title>
          <mat-card-subtitle>Return on Active Holdings</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <h2 class="metric-value" [ngClass]="summaryData.summary.unrealizedPnlAbsolute >= 0 ? 'positive' : 'negative'">
            {{ summaryData.summary.unrealizedPnlAbsolute | currency:'USD':'symbol':'1.2-2' }}
          </h2>
          <div class="metric-change" [ngClass]="summaryData.summary.unrealizedPnlPercentage >= 0 ? 'positive' : 'negative'">
            <mat-icon>{{ summaryData.summary.unrealizedPnlPercentage >= 0 ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
            <span>{{ summaryData.summary.unrealizedPnlPercentage | number:'1.1-2' }}% unrealized</span>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="metric-icon">paid</mat-icon>
          <mat-card-title>Realized Gain/Loss</mat-card-title>
          <mat-card-subtitle>From Sold Holdings</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <h2 class="metric-value" [ngClass]="summaryData.summary.realizedPnlAbsolute >= 0 ? 'positive' : 'negative'">
            {{ summaryData.summary.realizedPnlAbsolute | currency:'USD':'symbol':'1.2-2' }}
          </h2>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card">
        <mat-card-header>
          <mat-icon mat-card-avatar class="metric-icon">pie_chart</mat-icon>
          <mat-card-title>Asset Allocation</mat-card-title>
          <mat-card-subtitle>By Current Value</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="allocationChartData$ | async as chartData; else noChartData" style="height: 200px;">
            <ngx-charts-pie-chart
              *ngIf="chartData.length > 0"
              [results]="chartData"
              [legend]="false"
              [labels]="true"
              [doughnut]="true"
              [arcWidth]="0.25"
              [scheme]="allocationColorScheme" >
            </ngx-charts-pie-chart>
            <div *ngIf="chartData.length === 0" class="allocation-chart-placeholder">
              No allocation data available (value might be zero).
            </div>
          </div>
          <ng-template #noChartData>
            <div class="allocation-chart-placeholder">Loading chart...</div>
          </ng-template>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="holdings-section" *ngIf="summaryData.activeInvestments && summaryData.activeInvestments.length > 0">
      <div class="section-header">
        <h2>Active Holdings ({{ summaryData.summary.activeInvestmentsCount }})</h2>
        <button mat-raised-button color="primary" routerLink="../investments">
          <mat-icon>settings</mat-icon> Manage Investments
        </button>
      </div>
      <mat-card>
        <div class="table-responsive">
          <table class="holdings-table">
            <thead>
            <tr>
              <th>Asset (Ticker)</th>
              <th>Type</th>
              <th>Units</th>
              <th>Purchase Price</th>
              <th>Current Price</th>
              <th>Total Value</th>
              <th>Profit %</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let investment of summaryData.activeInvestments">
              <td>{{ investment.ticker }}</td>
              <td>{{ investment.type }}</td>
              <td>{{ investment.amount | number:'1.0-4' }}</td>
              <td>{{ investment.purchasePrice | currency:investment.currency:'symbol':'1.2-2' }}</td>
              <td>{{ (investment.currentValue ?? 0) | currency:investment.currency:'symbol':'1.2-2' }}</td>
              <td>{{ ((investment.currentValue ?? 0) * investment.amount) | currency:investment.currency:'symbol':'1.2-2' }}</td>
              <td>
                   <span class="profit-value"
                         *ngIf="investment.percentProfit !== null"
                         [class.positive]="(investment.percentProfit ?? 0) > 0"
                         [class.negative]="(investment.percentProfit ?? 0) < 0">
                      {{ investment.percentProfit | percent:'1.2-2' }}
                   </span>
                <span class="unavailable" *ngIf="investment.percentProfit === null">N/A</span>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </mat-card>
    </div>

    <div class="holdings-section" *ngIf="summaryData.soldInvestments && summaryData.soldInvestments.length > 0">
      <div class="section-header">
        <h2>Sold Holdings History</h2>
      </div>
      <mat-card>
        <div class="table-responsive">
          <table class="holdings-table">
            <thead>
            <tr>
              <th>Asset (Ticker)</th>
              <th>Type</th>
              <th>Units</th>
              <th>Purchase Price</th>
              <th>Sell Price</th>
              <th>Date Sold</th>
              <th>Realized PnL</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let investment of summaryData.soldInvestments">
              <td>{{ investment.ticker }}</td>
              <td>{{ investment.type }}</td>
              <td>{{ investment.amount | number:'1.0-4' }}</td>
              <td>{{ investment.purchasePrice | currency:investment.currency:'symbol':'1.2-2' }}</td>
              <td>{{ (investment.sellPrice ?? 0) | currency:investment.currency:'symbol':'1.2-2' }}</td>
              <td>{{ investment.lastUpdateDate | date:'shortDate' }}</td>
              <td>
                   <span class="profit-value"
                         *ngIf="investment.realizedPnl !== null"
                         [class.positive]="(investment.realizedPnl ?? 0) > 0"
                         [class.negative]="(investment.realizedPnl ?? 0) < 0">
                      {{ investment.realizedPnl | currency:investment.currency:'symbol':'1.2-2' }}
                   </span>
                <span class="unavailable" *ngIf="investment.realizedPnl === null">N/A</span>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </mat-card>
    </div>

  </div>

</ng-container>
